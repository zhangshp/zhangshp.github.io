---
title: "Certbot免费获取HTTPS证书"
date: 2018-05-04T09:10:11+08:00
draft: false
---

####Let's Encrypt与Certbot介绍

Let's Encrypt是一个一个公共且免费SSL的项目，由Mozilla、Cisco、Akamai、IdenTrust、EFF等组织人员发起，主要的目的也是为了推进网站从HTTP向HTTPS过度的进程，目前已经有越来越多的商家加入和赞助支持。

Certbot是一款易用的自动获取和部署SSL/TLS证书的工具。Certbot由EFF开发，被称为 Let’s Encrypt 官方客户端。我们获取免费证书的工具就是Certbot。



#### 安装Certbot

推荐上[Certbot](https://certbot.eff.org/) 官网安装，如果没有找到相对应的操作系统和服务器软件则执行下面命令安装：

```shell
wget https://dl.eff.org/certbot-auto
chmod a+x certbot-auto
```

Ununtu 16及更高版本如果出现`setuptools pkg_resources pip wheel failed with error code 1` 错误，请执行以下命令：

```shell
sudo apt-get install letsencrypt
export LC_ALL="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"
```



#### Certbot两种模式以及证书配置

- Webroot

  如果我们有权限修改服务器上的文件，并且不希望在证书获取过程中停止服务器的话可以使用Webroot模式。

  ```shell
  certbot certonly --webroot -w /var/www/example -d www.example.com
  ```

  `--webroot` 指定Webroot模式

  `-w`  指定网站根目录(webroot-path)

  `-d`  指定域名

  Webroot模式在网站根目录下创建临时文件(`{webroot-path}/.well-known/acme-challenge`)，然后Let’s Encrypt 通过发送HTTP请求去验证域名和服务器是否属于你。为了能通过验证，我们必须配置服务器以便能访问到隐藏的目录(.well-known/acme-challenge)。下面是nginx的配置的例子：

  ```nginx
  location /.well-known/acme-challenge {
           default_type  "text/plain";
           root        /var/www/example/;
   }
  ```

  其实 `-w ` 可以为任意目录，但是必须保证Let’s Encrypt 通过发送HTTP请求去验证的时候能访问到该目录。

- Standalone

  Standalone模式不依赖任何服务器软件，它会自己启动一个web server来验证域名。Standalone模式需要绑定80或者443端口，所以在获取证书的过程中我们需要停止我们的服务器。 下面是脚本：

  ```shell
  certbot certonly --standalone  -d www.example.com
  ```

  `--standalone` 指定standalone模式

  `-d` 指定域名

生成的证书位置在`/etc/letsencrypt/live` 下面。nginx配置例子：

```nginx
ssl_certificate      /etc/letsencrypt/live/www.example.com/fullchain.pem;
ssl_certificate_key  /etc/letsencrypt/live/www.example.com/privkey.pem;
```



#### 更新证书

由于通过Certbot生成的Let's Encrypt证书只有90天的有效期，所以我们需要在证书到期前更新证书。我们可以通过运行下面的脚本来更新更新我们的证书：

```shell
certbot renew
```

`renew` 会去更新距离过期时间少于30天的证书。

 我们还可以通过 cron job 来定时更新我们的证书，下面是一个每天凌晨和中午检查更新我们的证书例子：

```shell
0 0,12 * * * certbot renew 
```



> 注意，如果你用的 Webroot 模式，更新证书后记得重启下服务器。